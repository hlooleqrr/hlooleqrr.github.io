<script>
function askQuestion() {
  let qList = step < generalQuestions.length ? generalQuestions : commitmentQuestions;
  let qIndex = step < generalQuestions.length ? step : commitmentStep;
  let q = qList[qIndex];
  if (q.show && !q.show(answers)) {
    step++; askQuestion(); return;
  }
  let html = `<label>${q.label}</label>`;
  if (q.type === 'select') {
    html += `<select id="input">`;
    q.options.forEach(opt => html += `<option value="${opt}">${opt}</option>`);
    html += `</select>`;
  } else {
    html += `<input type="${q.type}" id="input">`;
  }
  document.getElementById("question").innerHTML = html;
  document.getElementById("nextContainer").style.display = "block";
}

function nextQuestion() {
  let qList = step < generalQuestions.length ? generalQuestions : commitmentQuestions;
  let qIndex = step < generalQuestions.length ? step : commitmentStep;
  let q = qList[qIndex];
  const val = document.getElementById("input").value;
  if (step < generalQuestions.length) {
    answers[q.id] = val;
    step++;
    if (q.id === 'birthHijriYear') setMonthsOptions();
    askQuestion();
  } else {
    currentCommitment[q.id] = val;
    commitmentStep++;
    if (commitmentStep === commitmentQuestions.length) {
      answers.commitments.push({...currentCommitment});
      currentCommitment = {}; commitmentStep = 0;
      if (val === 'Ù†Ø¹Ù…') askQuestion();
      else calculate();
    } else {
      askQuestion();
    }
  }
}

function setMonthsOptions() {
  const year = parseInt(answers.birthHijriYear);
  const age = 1446 - year;
  const retire = answers.jobType === 'Ø¹Ø³ÙƒØ±ÙŠ' ? getRetirementAge(answers.militaryRank) : 60;
  const remain = retire - age;
  let max = answers.financeType.includes("Ø´Ø®ØµÙŠ") ? 60 : Math.min(360, remain * 12);
  const monthsQ = generalQuestions.find(q => q.id === 'months');
  monthsQ.options = Array.from({length: max}, (_, i) => `${i + 1}`);
}

function getRetirementAge(rank) {
  const map = {"Ø¬Ù†Ø¯ÙŠ": 44, "Ø¬Ù†Ø¯ÙŠ Ø£ÙˆÙ„": 44, "Ø¹Ø±ÙŠÙ": 46, "ÙˆÙƒÙŠÙ„ Ø±Ù‚ÙŠØ¨": 46, "Ø±Ù‚ÙŠØ¨": 48, "Ø±Ù‚ÙŠØ¨ Ø£ÙˆÙ„": 50,
    "Ø±Ø¦ÙŠØ³ Ø±Ù‚Ø¨Ø§Ø¡": 52, "Ù…Ù„Ø§Ø²Ù…": 48, "Ù…Ù„Ø§Ø²Ù… Ø£ÙˆÙ„": 50, "Ù†Ù‚ÙŠØ¨": 52, "Ø±Ø§Ø¦Ø¯": 54,
    "Ù…Ù‚Ø¯Ù…": 56, "Ø¹Ù‚ÙŠØ¯": 58, "Ø¹Ù…ÙŠØ¯": 60, "Ù„ÙˆØ§Ø¡": 60};
  return map[rank] || 60;
}

function formatMonths(m) {
  const y = Math.floor(m / 12);
  const mo = m % 12;
  let txt = `${m} Ø´Ù‡Ø± (`;
  if (y > 0) txt += `${y} ${y === 1 ? 'Ø³Ù†Ø©' : 'Ø³Ù†ÙˆØ§Øª'}`;
  if (mo > 0) txt += ` Ùˆ${mo} ${mo === 1 ? 'Ø´Ù‡Ø±' : 'Ø£Ø´Ù‡Ø±'}`;
  return txt + ')';
}

function calculate() {
  const name = answers.name;
  const salary = parseFloat(answers.salary);
  const months = parseInt(answers.months);
  const maxDeduction = parseFloat(answers.deduction.replace('%','')) / 100;
  let available = salary * maxDeduction;
  let totalDeduct = 0;
  let msg = '';
  answers.commitments.forEach(c => {
    totalDeduct += parseFloat(c.monthly);
  });
  const netInstall = available - totalDeduct;
  let result = `<div class="result"><h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙˆÙ…Ø³Ù‡Ù„Ø§ ÙŠØ§ ${name}</h2>`;
  if (netInstall <= 0) {
    result += `<p style="color:red;">Ù†Ø¹ØªØ°Ø± Ù…Ù†Ùƒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙˆÙŠÙ„Ùƒ</p></div>`;
  } else {
    const finance = netInstall * months;
    const profit = finance * 0.04;
    const total = finance + profit;
    result += `<h3>ØªÙ…ÙˆÙŠÙ„Ùƒ Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª:</h3>`;
    result += `<p class="highlight">${finance.toFixed(0)} Ø±ÙŠØ§Ù„</p>`;
    result += `<p>Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ: ${profit.toFixed(0)} Ø±ÙŠØ§Ù„</p>`;
    result += `<p>Ù…Ø¯Ø© Ø§Ù„ØªÙ…ÙˆÙŠÙ„: ${formatMonths(months)}</p>`;
    result += `<p>ğŸ“0506214458 Ø²ÙˆØ±Ùˆ Ù…ÙˆÙ‚Ø¹Ù†Ø§: hlooleqrr.com</p></div>`;
  }
  document.getElementById("form-container").innerHTML = result;
  document.getElementById("resetButtonContainer").style.display = "block";
}

function handleStartOrReset() {
  step = 0; answers = { commitments: [] };
  document.getElementById("mainButton").style.display = "none";
  askQuestion();
}

function resetCalc() {
  location.reload();
}

function updateDateTime() {
  const now = new Date();
  const h = now.getHours().toString().padStart(2, '0');
  const m = now.getMinutes().toString().padStart(2, '0');
  const d = now.getDate().toString().padStart(2, '0');
  const mo = (now.getMonth() + 1).toString().padStart(2, '0');
  const y = now.getFullYear();
  document.getElementById("datetime").innerText = `Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ: ${y}/${mo}/${d} - Ø§Ù„ÙˆÙ‚Øª: ${h}:${m}`;
}
setInterval(updateDateTime, 1000); updateDateTime();
</script>