<script>
function askQuestion() {
  let qList = step < generalQuestions.length ? generalQuestions : commitmentQuestions;
  let qIndex = step < generalQuestions.length ? step : commitmentStep;
  let q = qList[qIndex];
  if (q.show && !q.show(answers)) {
    step++; askQuestion(); return;
  }
  let html = `<label>${q.label}</label>`;
  if (q.type === 'select') {
    html += `<select id="input">`;
    q.options.forEach(opt => html += `<option value="${opt}">${opt}</option>`);
    html += `</select>`;
  } else {
    html += `<input type="${q.type}" id="input">`;
  }
  document.getElementById("question").innerHTML = html;
  document.getElementById("nextContainer").style.display = "block";
}

function nextQuestion() {
  let qList = step < generalQuestions.length ? generalQuestions : commitmentQuestions;
  let qIndex = step < generalQuestions.length ? step : commitmentStep;
  let q = qList[qIndex];
  const val = document.getElementById("input").value;
  if (step < generalQuestions.length) {
    answers[q.id] = val;
    step++;
    if (q.id === 'birthHijriYear') setMonthsOptions();
    askQuestion();
  } else {
    currentCommitment[q.id] = val;
    commitmentStep++;
    if (commitmentStep === commitmentQuestions.length) {
      answers.commitments.push({...currentCommitment});
      currentCommitment = {}; commitmentStep = 0;
      if (val === 'نعم') askQuestion();
      else calculate();
    } else {
      askQuestion();
    }
  }
}

function setMonthsOptions() {
  const year = parseInt(answers.birthHijriYear);
  const age = 1446 - year;
  const retire = answers.jobType === 'عسكري' ? getRetirementAge(answers.militaryRank) : 60;
  const remain = retire - age;
  let max = answers.financeType.includes("شخصي") ? 60 : Math.min(360, remain * 12);
  const monthsQ = generalQuestions.find(q => q.id === 'months');
  monthsQ.options = Array.from({length: max}, (_, i) => `${i + 1}`);
}

function getRetirementAge(rank) {
  const map = {"جندي": 44, "جندي أول": 44, "عريف": 46, "وكيل رقيب": 46, "رقيب": 48, "رقيب أول": 50,
    "رئيس رقباء": 52, "ملازم": 48, "ملازم أول": 50, "نقيب": 52, "رائد": 54,
    "مقدم": 56, "عقيد": 58, "عميد": 60, "لواء": 60};
  return map[rank] || 60;
}

function formatMonths(m) {
  const y = Math.floor(m / 12);
  const mo = m % 12;
  let txt = `${m} شهر (`;
  if (y > 0) txt += `${y} ${y === 1 ? 'سنة' : 'سنوات'}`;
  if (mo > 0) txt += ` و${mo} ${mo === 1 ? 'شهر' : 'أشهر'}`;
  return txt + ')';
}

function calculate() {
  const name = answers.name;
  const salary = parseFloat(answers.salary);
  const months = parseInt(answers.months);
  const maxDeduction = parseFloat(answers.deduction.replace('%','')) / 100;
  let available = salary * maxDeduction;
  let totalDeduct = 0;
  let msg = '';
  answers.commitments.forEach(c => {
    totalDeduct += parseFloat(c.monthly);
  });
  const netInstall = available - totalDeduct;
  let result = `<div class="result"><h2>مرحباً ومسهلا يا ${name}</h2>`;
  if (netInstall <= 0) {
    result += `<p style="color:red;">نعتذر منك لا يمكن تمويلك</p></div>`;
  } else {
    const finance = netInstall * months;
    const profit = finance * 0.04;
    const total = finance + profit;
    result += `<h3>تمويلك الصافي بعد خصم الالتزامات:</h3>`;
    result += `<p class="highlight">${finance.toFixed(0)} ريال</p>`;
    result += `<p>الربح التقديري: ${profit.toFixed(0)} ريال</p>`;
    result += `<p>مدة التمويل: ${formatMonths(months)}</p>`;
    result += `<p>📞0506214458 زورو موقعنا: hlooleqrr.com</p></div>`;
  }
  document.getElementById("form-container").innerHTML = result;
  document.getElementById("resetButtonContainer").style.display = "block";
}

function handleStartOrReset() {
  step = 0; answers = { commitments: [] };
  document.getElementById("mainButton").style.display = "none";
  askQuestion();
}

function resetCalc() {
  location.reload();
}

function updateDateTime() {
  const now = new Date();
  const h = now.getHours().toString().padStart(2, '0');
  const m = now.getMinutes().toString().padStart(2, '0');
  const d = now.getDate().toString().padStart(2, '0');
  const mo = (now.getMonth() + 1).toString().padStart(2, '0');
  const y = now.getFullYear();
  document.getElementById("datetime").innerText = `الميلادي: ${y}/${mo}/${d} - الوقت: ${h}:${m}`;
}
setInterval(updateDateTime, 1000); updateDateTime();
</script>