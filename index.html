<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>سرعة تملك العقار والحلول التمويلية</title>
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f4f6f8; margin:0; text-align:center; font-size:32px; }
    header { background:#005c48; color:#fff; padding:25px; font-size:40px; }
    h2 { font-size:32px; margin:10px 0 20px; }
    .container { max-width:650px; margin:0 auto 25px; background:#fff; padding:25px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.1); }
    input, select, button { width:92%; padding:20px; margin:18px 0; font-size:32px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
    .result p { margin:12px 0; text-align:right; }
    .highlight { color:#2e7d32; font-size:36px; }
    #resetButtonContainer {
      position:fixed; bottom:15px; left:50%; transform:translateX(-50%); z-index:1000;
      display:none; background:#e3f2fd; padding:4px 8px; border-radius:5px;
    }
    #resetButtonContainer button {
      background:transparent; border:none; color:#005c48; font-size:16px; cursor:pointer;
    }
    footer { margin-top:40px; font-size:24px; color:#555; }
  </style>
</head>
<body>
  <header>سرعة تملك العقار والحلول التمويلية</header>
  <h2>حاسبة التمويل التقريبية</h2>

  <div class="container">
    <div id="question"></div>
    <button id="mainButton" onclick="handleStartOrReset()">ابدأ الحسبة</button>
    <div id="nextContainer" style="display:none;">
      <button onclick="nextQuestion()">التالي</button>
    </div>
  </div>

  <div id="resetButtonContainer">
    <button onclick="handleStartOrReset()">إعادة الحسبة 🔁</button>
  </div>

  <footer>
    <p id="datetimeFooter"></p>
  </footer>

  <script>
    // تحديث التاريخ والوقت كل ثانية
    function updateDateTime(){
      document.getElementById('datetimeFooter').innerText =
        `جميع الحقوق محفوظة - سرعة تملك العقار - هجري: 1446/12/21 - ميلادي: 2025/06/27 - الوقت: 12:44`;
    }
    setInterval(updateDateTime,1000);
    updateDateTime();

    // حالة الأسئلة
    let hasStarted = false, step = 0, commitmentStep = 0;
    let answers = { commitments: [] }, currentCommitment = {};

    // الأسئلة العامة
    const generalQuestions = [
      { id:'financeType', label:'اختر نوع التمويل تريد حسبته:', type:'select', options:['تمويل عقاري','تمويل شخصي أو استهلاكي'] },
      { id:'clientName',  label:'الاسم الكريم:',               type:'text' },
      { id:'birthHijri',  label:'تاريخ الميلاد (هجري):',       type:'dateHijri' },
      { id:'jobType',     label:'نوع الوظيفة:',                type:'select', options:['عسكري','مدني','خاص شبه حكومي','خاص معتمد','خاص غير معتمد'] },
      { show:a=>a.jobType==='عسكري',
        id:'rank',       label:'حدد رتبتك العسكرية:',          type:'select',
        options:['جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء']
      },
      { show:()=>answers.jobType==='عسكري'&&getRetirementMonths()<25*12,
        id:'extended',   label:'هل تريد الحسبة ممتدة بعد التقاعد؟', type:'select', options:['نعم','لا'] },
      { show:a=>a.extended==='نعم',
        id:'basicSalary',label:'الراتب الأساسي (بدون بدلات، ريال):', type:'number' },
      { show:a=>a.extended==='نعم',
        id:'appointHijri',label:'تاريخ التعيين (هجري):',          type:'dateHijri' },
      { id:'salary',     label:'الراتب الشهري الحالي (ريال):',  type:'number' },
      { id:'profitMargin',label:'هامش الربح (%):',              type:'number', default:'4.5' },
      { id:'months',     label:'عدد أشهر التمويل:',             type:'select', dynamic:true },
      { id:'hasCommitments',label:'هل لديك التزامات مالية؟',   type:'select', options:['نعم','لا'] }
    ];

    // أسئلة الالتزامات
    const commitmentQuestions = [
      { id:'type',    label:'نوع الالتزام:',           type:'select', options:['قرض سيارة','قرض شخصي','قرض استهلاكي'] },
      { id:'amount',  label:'القسط الشهري (ريال):',     type:'number' },
      { id:'months',  label:'أشهر الالتزام المتبقية:',  type:'select', dynamic:true },
      { id:'balloon', label:'هل لديك دفعة أخيرة؟',     type:'select', options:['نعم','لا'] },
      { show:c=>c.balloon==='نعم', id:'balloonAmount', label:'مبلغ الدفعة الأخيرة (ريال):', type:'number' },
      { id:'more',    label:'هل لديك التزام آخر؟',     type:'select', options:['نعم','لا'] }
    ];

    function getRetirementMonths(){
      const cur=1446, birth=parseInt(answers.birthHijriYear)||cur, age=cur-birth;
      const ranks={جندي:44,'جندي أول':44,عريف:46,'وكيل رقيب':46,رقيب:48,'رقيب أول':50,'رئيس رقباء':52,
                   ملازم:48,'ملازم أول':50,نقيب:52,رائد:54,مقدم:56,عقيد:58,عميد:60,لواء:60};
      const retireAge = answers.jobType==='عسكري' ? (ranks[answers.rank]||60) : 60;
      return Math.max(0, (retireAge - age) * 12);
    }

    function getMaxAllowedMonths(){
      const cur=1446, birth=parseInt(answers.birthHijriYear)||cur, age=cur-birth;
      const until60 = (60 - age) * 12;
      const base = (answers.financeType||'').includes('شخصي')||(answers.financeType||'').includes('استهلاكي')?60:360;
      return answers.extended==='نعم'?Math.min(until60,base):Math.min(getRetirementMonths(),base);
    }

    function describeMonths(m){
      const y=Math.floor(m/12), mm=m%12;
      let t=`${m} شهر`;
      if(y||mm){
        t+=' ('; if(y){ if(y===2)t+='سنتان';else if(y===3)t+='ثلاث سنوات';else if(y===4)t+='أربع سنوات';else if(y===5)t+='خمس سنوات';else t+=`${y} سنوات`; }
        if(y&&mm) t+=' و'; if(mm){ if(mm===1)t+='شهر';else if(mm===2)t+='شهران';else t+=`${mm} أشهر`; } t+=')';
      }
      return t;
    }

    function handleStartOrReset(){
      if(!hasStarted){
        hasStarted=true;
        document.getElementById('mainButton').style.display='none';
        document.getElementById('resetButtonContainer').style.display='block';
        showQuestion();
      } else {
        // إعادة التهيئة
        answers={commitments:[]};
        step=commitmentStep=0;
        currentCommitment={};
        showQuestion();
      }
    }

    function showQuestion(){
      const cont=document.getElementById('question');
      cont.innerHTML='';
      document.getElementById('nextContainer').style.display='block';
      let q;
      if(step<generalQuestions.length){
        q=generalQuestions[step];
        if(q.show&&!q.show(answers)){ step++; return showQuestion(); }
      } else if(answers.hasCommitments==='نعم'){
        q=commitmentQuestions[commitmentStep];
        if(q.show&&!q.show(currentCommitment)){ commitmentStep++; return showQuestion(); }
      } else {
        document.getElementById('nextContainer').style.display='none';
        return calculate();
      }
      const div=document.createElement('div'); div.classList.add('fade-in');
      div.innerHTML=`<label>${q.label}</label><br>`;
      if(q.type==='select'){
        const sel=document.createElement('select'); sel.id=q.id;
        sel.innerHTML='<option value="">اختر...</option>';
        if(q.dynamic){
          const limit = (step<generalQuestions.length?getMaxAllowedMonths():60);
          for(let i=1;i<=limit;i++) sel.innerHTML+=`<option value="${i}">${describeMonths(i)}</option>`;
        } else {
          q.options.forEach(opt=>sel.innerHTML+=`<option value="${opt}">${opt}</option>`);
        }
        div.appendChild(sel);
      } else {
        div.innerHTML+=`<input type="${q.type}" id="${q.id}" ${q.default?`value="${q.default}"`:''}>`;
      }
      cont.appendChild(div);
    }

    function nextQuestion(){
      const q = step<generalQuestions.length?generalQuestions[step]:commitmentQuestions[commitmentStep];
      const el=document.getElementById(q.id), val=el?.value;
      if(!val){ alert('يرجى تعبئة الحقل قبل المتابعة'); return; }
      if(step<generalQuestions.length){
        answers[q.id]=val;
        if(q.id==='months'&&parseInt(val)>getMaxAllowedMonths()){
          alert(`أقصى مدة: ${describeMonths(getMaxAllowedMonths())}`); answers[q.id]=getMaxAllowedMonths().toString();
        }
        step++;
      } else {
        if(q.id==='months') currentCommitment.months=parseInt(val);
        else if(q.id==='amount'||q.id==='balloonAmount') currentCommitment[q.id]=parseFloat(val);
        else currentCommitment[q.id]=val;
        if(q.id==='more'){
          answers.commitments.push(currentCommitment);
          currentCommitment={}; commitmentStep=0;
          if(val==='نعم'){ return showQuestion(); }
          else { return calculate(); }
        }
        commitmentStep++;
      }
      showQuestion();
    }

    function calculate(){
      document.getElementById('nextContainer').style.display='none';
      const salary=parseFloat(answers.salary),
            months=parseInt(answers.months),
            years=months/12,
            profitMargin=parseFloat(answers.profitMargin),
            { financeType, supported, bundle } = answers;
      let deductionRate=0, addCommodityFee=false;
      if(financeType.includes('شخصي')||financeType.includes('استهلاكي')){
        deductionRate=45; addCommodityFee=true;
      } else {
        if(supported==='مدعوم'&&!bundle) deductionRate=65;
        else deductionRate=salary<15000?55:65;
      }
      const allowedInst=salary*deductionRate/100;
      const commits=[...answers.commitments].sort((a,b)=>a.months-b.months);
      let balloonPhases=[];
      commits.forEach(c=>{
        if(c.type==='قرض سيارة'&&c.balloon==='نعم'&&c.balloonAmount){
          balloonPhases.push({start:c.months,end:c.months+24,value:c.balloonAmount/24});
        }
      });
      let futurePhases=[];
      for(let m=1;m<=months;m++){
        let base=commits.filter(c=>m<=c.months).reduce((s,c)=>s+c.amount,0);
        let extra=balloonPhases.reduce((s,b)=>(m>=b.start&&m<b.end)?s+b.value:s,0);
        let avail=allowedInst-base-extra;
        if(financeType.includes('شخصي')||financeType.includes('استهلاكي')) avail=Math.min(avail,salary/3);
        futurePhases.push({month:m,inst:avail});
      }
      let finalPhases=[];
      futurePhases.forEach(p=>{
        if(!finalPhases.length||finalPhases.at(-1).inst!==p.inst) finalPhases.push({from:p.month,to:p.month,inst:p.inst});
        else finalPhases.at(-1).to=p.month;
      });
      const totalInst=finalPhases.reduce((s,p)=>s+p.inst*(p.to-p.from+1),0);
      const profitFactor=years*profitMargin/100+1;
      const netFinance=totalInst/profitFactor;
      let adminFee=netFinance*0.01, vat=adminFee*0.15;
      if(adminFee+vat>5750){adminFee=5000;vat=750;}
      const commodityFee=addCommodityFee?netFinance*0.01:0;
      const finalNet=netFinance-(adminFee+vat+commodityFee);
      const totalProfitWithFees=totalInst-finalNet;
      let supportText='';
      if(financeType==='تمويل عقاري'&&supported==='مدعوم'){
        const sup=salary<10000?150000:100000;
        if(bundle==='نعم') supportText=`<p class="highlight">دعم حكومي: ${sup.toLocaleString()} ريال</p>`;
        else {
          const dist=Math.min(months,240), monthly=Math.round(sup/dist);
          supportText=`<p class="highlight">دعم ${sup.toLocaleString()} ريال موزع على ${dist} شهر = ${monthly.toLocaleString()} ريال</p>`;
        }
      }
      const name=answers.clientName||'العميل';
      const duration=describeMonths(months);
      const finalNetFixed=finalNet.toFixed(0);
      let html=`<div class="result"><h2>نتيجة الحسبة (تقريبية):</h2>
        <p class="highlight">مرحباً يا ${name}</p>
        <p>مدة التمويل: <strong>${duration}</strong></p>`;
      if(finalPhases.every(p=>p.inst<=0)){
        html+=`<p class="highlight" style="color:red;font-size:38px;">نعتذر لا يمكن تمويلك</p>`;
      }
      finalPhases.forEach(p=>{
        html+=`<p>القسط من ${p.from} إلى ${p.to}: ${p.inst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</p>`;
      });
      html+=`
        <p class="highlight" style="color:green;font-size:44px;">التمويل الصافي بعد الرسوم: ${finalNetFixed.replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</p>
        ${supportText}
        <p style="color:green;font-size:36px;"><strong>التمويل قبل الرسوم:</strong> ${netFinance.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</p>
        <p style="color:red;font-size:36px;"><strong>الربح دون رسوم:</strong> ${(totalInst-netFinance).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</p>
        <p style="color:red;font-size:42px;"><strong>الربح مع رسوم:</strong> ${totalProfitWithFees.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</p>
        <p><strong>معامل الربح:</strong> ${profitFactor.toFixed(3)}</p>
        <p><strong>الرسوم الإدارية:</strong> ${adminFee.toFixed(0)} ريال</p>
        <p><strong>ضريبة الرسوم:</strong> ${vat.toFixed(0)} ريال</p>
        ${addCommodityFee?`<p><strong>رسوم السلع:</strong> ${commodityFee.toFixed(0)} ريال</p>`:''}
        <p><strong>إجمالي التمويل مع الأرباح:</strong> ${totalInst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ريال</p>
        <p><strong>بالأحرف:</strong> ${numberToArabicWords(parseInt(finalNetFixed))}</p>
        <h3>للاستفسار 📞0506214458 - hlooleqrr.com</h3>
      </div>`;
      document.getElementById('question').innerHTML = html;
      document.getElementById('resetButtonContainer').style.display = 'block';
    }
  </script>
</body>
</html>