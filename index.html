<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>حاسبة التمويل</title>
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f4f6f8; margin: 0; text-align: center; font-size: 32px; }
    header { background: #005c48; color: #fff; padding: 25px; font-size: 34px; }
    .container { max-width: 650px; margin: 25px auto; background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,.1); }
    input, select, button { width: 92%; padding: 20px; margin: 18px 0; font-size: 32px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    select option { font-size: 30px; }
    button { background: #00796b; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #004d40; }
    .small-reset { font-size: 28px; padding: 12px 20px; margin-top: 22px; background: #e3f2fd; color: #1565c0; border: none; cursor: pointer; border-radius: 15px; }
    .small-reset:hover { background: #bbdefb; }
    footer { font-size: 26px; color: #666; margin-top: 40px; padding: 15px; }
    .fade-in { opacity: 0; transform: translateY(20px); animation: fadeInMove .6s forwards; }
    @keyframes fadeInMove { to { opacity: 1; transform: translateY(0); } }
    .result p { margin: 12px 0; font-size: 30px; line-height: 1.6; }
    .result h2, .result h3 { font-size: 34px; }
    .highlight { font-size: 36px; font-weight: bold; color: #004d40; }
  </style>
</head>
<body>
<header>
  <h1>سرعة تملك العقار والحلول التمويلية</h1>
  <p>حاسبة التمويل التقريبية</p>
</header>
<div class="container" id="form-container">
  <div id="question"></div>
  <button id="mainButton" onclick="handleStartOrReset()">ابدأ الحسبة</button>
  <div id="nextContainer" style="display:none">
    <button onclick="nextQuestion()">التالي</button>
  </div>
  <div id="resetButtonContainer" style="display:none">
    <button class="small-reset" onclick="resetCalc()">🔁 إعادة الحسبة</button>
  </div>
</div>
<script>
let answers = { commitments: [] }, step = 0, commitmentStep = 0, currentCommitment = {};
let hasStarted = false;<script>
const generalQuestions = [

  // ✅ 1. اسم العميل
  { id:'clientName', label:'اسمك الكريم', type:'text' },

  // ✅ 2. نوع التمويل (يظهر دائمًا ثانيًا حسب الاتفاق)
  {
    id:'financeType',
    label:'اختر نوع التمويل تريد حسبته:',
    type:'select',
    options:['تمويل شخصي أو تمويل استهلاكي','تمويل عقاري']
  },

  // ✅ 3. تاريخ الميلاد (يوم/شهر/سنة)
  { id:'birthDay', label:'اختر يوم الميلاد:', type:'select', options:Array.from({length:30},(_,i)=>i+1), default:1 },
  { id:'birthMonth', label:'اختر شهر الميلاد:', type:'select', options:Array.from({length:12},(_,i)=>i+1), default:1 },
  { id:'birthYear', label:'اختر سنة الميلاد:', type:'select', options:Array.from({length:61},(_,i)=>1370+i), default:1412 },

  // ✅ 4. نوع الوظيفة
  {
    id:'jobType',
    label:'نوع الوظيفة',
    type:'select',
    options:[
      'عسكري',
      'مدني (قطاع حكومي)',
      'خاص (شبه حكومي)',
      'خاص (شركة معتمدة)',
      'خاص (شركة غير معتمدة)'
    ]
  },

  // ✅ 5. الرتبة العسكرية (يظهر فقط إذا الوظيفة = عسكري)
  {
    id:'militaryRank',
    label:'اذكر الرتبة العسكرية',
    type:'select',
    options:[
      'جندي','عريف','رقيب','رئيس رقباء','نقيب',
      'رائد','مقدم','عقيد','عميد','لواء'
    ],
    show: a => a.jobType === 'عسكري'
  },

  // ✅ 6. دعم التمويل (إذا التمويل عقاري)
  {
    id:'supported',
    label:'هل التمويل مدعوم؟',
    type:'select',
    options:['مدعوم','غير مدعوم'],
    show: a => a.financeType === 'تمويل عقاري'
  },

  // ✅ 7. دفعة مقدمة من سكني (إذا التمويل مدعوم)
  {
    id:'bundle',
    label:'هل ترغب في دفعة مقدمة من سكني؟',
    type:'select',
    options:['نعم','لا'],
    show: a => a.supported === 'مدعوم'
  },

  // ✅ 8. سؤال التقاعد الممتد (إذا التمويل عقاري + عسكري + متبقي أقل من 25 سنة)
  {
    id:'extendedRetirement',
    label:'هل ترغب في الحسبة على التقاعد الممتد؟',
    type:'select',
    options:['نعم','لا'],
    show: a => {
      if (a.financeType !== 'تمويل عقاري' || a.jobType !== 'عسكري') return false;
      const age = 1446 - parseInt(a.birthYear);
      const retireAge = getRetirementAge(a.militaryRank || 'جندي');
      return (retireAge - age) < 25;
    }
  },

  // ✅ 9. تاريخ التعيين (إذا وافق على الحسبة الممتدة)
  {
    id:'hireDay',
    label:'اختر يوم التعيين:',
    type:'select',
    options: Array.from({length:30},(_,i)=>i+1),
    default:1,
    show: a => a.extendedRetirement === 'نعم'
  },
  {
    id:'hireMonth',
    label:'اختر شهر التعيين:',
    type:'select',
    options: Array.from({length:12},(_,i)=>i+1),
    default:1,
    show: a => a.extendedRetirement === 'نعم'
  },
  {
    id:'hireYear',
    label:'اختر سنة التعيين:',
    type:'select',
    options: Array.from({length:36},(_,i)=>1410+i),
    default:1420,
    show: a => a.extendedRetirement === 'نعم'
  },

  // ✅ 10. الراتب الشهري الصافي
  { id:'salary', label:'كم الراتب الشهري الصافي؟', type:'number' },

  // ✅ 11. عدد أشهر التمويل (يُحسب حسب السن/التقاعد)
  { id:'months', label:'على كم شهر تريد التمويل؟', type:'select', options:[], dynamic:true },

  // ✅ 12. هامش الربح السنوي
  { id:'profitMargin', label:'نسبة هامش الربح السنوي (%)؟', type:'number' },

  // ✅ 13. هل توجد التزامات؟
  { id:'hasCommitments', label:'هل لديك التزامات؟', type:'select', options:['نعم','لا'] }

];
</script><script>
// ⚙️ أسئلة الالتزامات تتكرر حسب عدد الالتزامات
const commitmentQuestions = [
  {
    id:'commitmentType',
    label:'ما نوع الالتزام؟',
    type:'select',
    options:['قرض سيارة','قرض استهلاكي','قرض آخر']
  },
  {
    id:'commitmentValue',
    label:'كم القسط الشهري لهذا الالتزام؟',
    type:'number'
  },
  {
    id:'commitmentMonths',
    label:'كم شهر متبقي على هذا الالتزام؟',
    type:'select',
    options: Array.from({length:360},(_,i)=>i+1)
  },
  {
    id:'hasFinalPayment',
    label:'هل يوجد دفعة أخيرة؟',
    type:'select',
    options:['نعم','لا'],
    show: a => a.commitmentType === 'قرض سيارة'
  },
  {
    id:'finalPaymentValue',
    label:'كم مبلغ الدفعة الأخيرة؟',
    type:'number',
    show: a => a.commitmentType === 'قرض سيارة' && a.hasFinalPayment === 'نعم'
  },
  {
    id:'anotherCommitment',
    label:'هل لديك التزام آخر؟',
    type:'select',
    options:['نعم','لا']
  }
];

// 🧠 دالة سن التقاعد حسب الرتبة العسكرية
function getRetirementAge(rank){
  return {
    'جندي': 44, 'عريف': 46, 'رقيب': 48, 'رئيس رقباء': 52,
    'نقيب': 52, 'رائد': 54, 'مقدم': 56, 'عقيد': 58,
    'عميد': 60, 'لواء': 60
  }[rank] || 44;
}

// 💰 دالة استخراج الراتب الأساسي حسب الرتبة
function getBaseSalaryByRank(rank){
  return {
    'جندي': 4500, 'عريف': 5000, 'رقيب': 6000, 'رئيس رقباء': 7000,
    'نقيب': 8000, 'رائد': 9000, 'مقدم': 10000, 'عقيد': 11000,
    'عميد': 12000, 'لواء': 13000
  }[rank] || 4500;
}

// ✅ متغيرات إدارة خطوات الالتزامات
let commitmentStep = 0;
let currentCommitment = {};
</script><script>
function calculate() {
  const salary = parseFloat(answers.salary);
  const months = parseInt(answers.months);
  const years = months / 12;
  const profitMargin = parseFloat(answers.profitMargin);
  const financeType = answers.financeType;
  const supported = answers.supported;
  const bundle = answers.bundle;
  const jobType = answers.jobType;
  const birthYear = parseInt(answers.birthYear);
  const rank = answers.militaryRank;

  const hijriNow = 1446;
  const age = hijriNow - birthYear;

  // سن التقاعد حسب الرتبة
  const retirementAge = jobType === 'عسكري' ? getRetirementAge(rank) : 60;
  const retirementYear = birthYear + retirementAge;
  const retirementMonth = (retirementYear - hijriNow) * 12;

  // راتب التقاعد (في حالة العسكري الممتد فقط)
  let postRetirementInst = 0;
  if (answers.extendedRetirement === 'نعم') {
    const base = getBaseSalaryByRank(rank);
    const yearsWorked = hijriNow - parseInt(answers.hireYear);
    const pension = (base * yearsWorked) / 40;
    postRetirementInst = pension * 0.55;
  }

  // نسبة الاستقطاع
  let instPercent = 0.55;
  if (financeType === 'تمويل عقاري') {
    if (salary >= 15000 || (supported === 'مدعوم' && bundle === 'لا')) instPercent = 0.65;
  } else if (financeType === 'تمويل شخصي أو تمويل استهلاكي') {
    instPercent = answers.hasCommitments === 'نعم' ? 0.45 : 0.33;
  }

  const maxInst = salary * instPercent;
  let monthlyInsts = Array(months).fill(maxInst);

  // احتساب الالتزامات
  if (answers.hasCommitments === 'نعم') {
    let pointer = 0;
    for (const c of answers.commitments) {
      let value = parseFloat(c.commitmentValue);
      let duration = parseInt(c.commitmentMonths);
      if (c.commitmentType === 'قرض سيارة' && c.hasFinalPayment === 'نعم') {
        const finalPay = parseFloat(c.finalPaymentValue);
        value += finalPay / 24;
        duration = Math.max(duration, 60); // لضمان توزيع الدفعة الأخيرة بعد انتهاء القسط العادي
      }
      for (let i = pointer; i < pointer + duration && i < months; i++) {
        monthlyInsts[i] -= value;
      }
      pointer += duration;
    }
  }

  // الحسبة بعد التقاعد الممتد
  if (answers.extendedRetirement === 'نعم' && financeType === 'تمويل عقاري') {
    for (let i = retirementMonth; i < months; i++) {
      monthlyInsts[i] = Math.min(monthlyInsts[i], postRetirementInst);
    }
  }

  // حذف القيم السالبة
  monthlyInsts = monthlyInsts.map(m => m < 0 ? 0 : m);

  // احتساب المبلغ الممول
  const totalPaid = monthlyInsts.reduce((a,b)=>a+b,0);
  const monthlyRate = profitMargin / 12 / 100;
  const financeAmount = totalPaid / ((monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1));
  const adminFees = Math.min(5000, financeAmount * 0.01);
  const totalFees = adminFees * 1.15;
  const netAmount = financeAmount - totalFees;
  const totalProfit = totalPaid - financeAmount;
  const totalProfitWithFees = totalPaid - netAmount;

  // عرض النتيجة
  showResult(monthlyInsts, netAmount, totalProfit, totalProfitWithFees, months);
}
</script><script>
function showResult(monthlyInsts, netAmount, profit, profitWithFees, months){
  const container = document.getElementById("resultContainer");
  const resultBox = document.getElementById("resultBox");
  const name = answers.clientName;
  const parts = describeMonths(months);
  const durationStr = `${months} شهر (${parts})`;

  // عرض الأقساط المتغيرة
  let ranges = [];
  let start = 0;
  for(let i = 1; i <= monthlyInsts.length; i++){
    if(i === monthlyInsts.length || monthlyInsts[i] !== monthlyInsts[start]){
      const from = start + 1;
      const to = i;
      const value = Math.round(monthlyInsts[start]);
      if(value > 0){
        ranges.push(`من ${from} إلى ${to} = ${value.toLocaleString()} ريال`);
      }
      start = i;
    }
  }

  // أرقام التنسيق
  const formatNumber = num => Math.round(num).toLocaleString();
  const greeting = `مرحباً ومسهلا يا ${name}`;
  const netText = `تمويلك الصافي يا ${name} بعد خصم الرسوم: ${formatNumber(netAmount)} ريال`;
  const profitText = `الربح دون الرسوم: ${formatNumber(profit)} ريال`;
  const profitFeesText = `الربح مع الرسوم: ${formatNumber(profitWithFees)} ريال`;

  // دعم سكني (إن وُجد)
  let supportText = '';
  if (answers.financeType === 'تمويل عقاري' && answers.supported === 'مدعوم') {
    supportText = `<div style="color:#007700;font-size:30px">التمويل الصافي مع الدعم: ${formatNumber(answers.calculatedFinance)} ريال</div><br>`;
  }

  // لا يمكن تمويله
  if(monthlyInsts.every(v => v <= 0)){
    resultBox.innerHTML = `<div style="color:red;font-size:36px">نعتذر منك لا يمكن تمويلك</div>`;
  }else{
    resultBox.innerHTML = `
      <div style="color:#005c48;font-weight:bold;font-size:36px">${greeting}</div><br>
      <div style="color:#005c48;font-size:32px">${netText}</div><br>
      ${supportText}
      <div style="color:#b30000;font-size:30px">${profitText}</div>
      <div style="color:#b30000;font-size:30px">${profitFeesText}</div><br>
      ${ranges.map(r => `<div>${r}</div>`).join("")}
      <br><div style="font-size:28px">مدة التمويل: ${durationStr}</div>
      <br><br>
      <span style="font-size:26px;color:gray">💡 خذ لقطة للشاشة وراسلنا لمساعدتك في خطوات التملك</span><br>
      <span style="font-size:26px;color:#005c48">📞 للتواصل: 0530000000</span><br>
      <span style="font-size:26px;color:#005c48">🌐 www.hlooleqrr.com</span>
    `;
  }

  container.style.display = 'block';
}
</script><script>
function handleStartOrReset() {
  if (!hasStarted) {
    hasStarted = true;
    document.getElementById('mainButton').style.display = 'none';
    document.getElementById('resetButtonContainer').style.display = 'block';
    showQuestion();
  } else {
    resetCalc();
  }
}

function resetCalc() {
  answers = { commitments: [] };
  step = 0;
  commitmentStep = 0;
  currentCommitment = {};
  hasStarted = true;
  document.getElementById('mainButton').style.display = 'none';
  document.getElementById('resetButtonContainer').style.display = 'block';
  document.getElementById('resultContainer').style.display = 'none';
  showQuestion();
}

function showQuestion() {
  const cont = document.getElementById('question');
  cont.innerHTML = '';
  document.getElementById('nextContainer').style.display = 'block';
  let q;

  if (step < generalQuestions.length) {
    q = generalQuestions[step];
    if (q.show && !q.show(answers)) {
      step++;
      showQuestion();
      return;
    }

    const label = document.createElement('label');
    label.innerText = q.label;
    cont.appendChild(label);

    let input;
    if (q.type === 'select') {
      input = document.createElement('select');
      q.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.innerText = opt;
        input.appendChild(option);
      });
      if (q.default) input.value = q.default;
    } else {
      input = document.createElement('input');
      input.type = q.type;
    }

    input.value = answers[q.id] || '';
    input.oninput = e => answers[q.id] = e.target.value;
    cont.appendChild(input);

  } else if (answers.hasCommitments === 'نعم') {
    q = commitmentQuestions[commitmentStep];
    if (q.show && !q.show(currentCommitment)) {
      commitmentStep++;
      showQuestion();
      return;
    }

    const label = document.createElement('label');
    label.innerText = q.label;
    cont.appendChild(label);

    let input;
    if (q.type === 'select') {
      input = document.createElement('select');
      q.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.innerText = opt;
        input.appendChild(option);
      });
    } else {
      input = document.createElement('input');
      input.type = q.type;
    }

    input.value = currentCommitment[q.id] || '';
    input.oninput = e => currentCommitment[q.id] = e.target.value;
    cont.appendChild(input);

  } else {
    calculate();
    document.getElementById('nextContainer').style.display = 'none';
  }
}

function nextQuestion() {
  if (step < generalQuestions.length) {
    step++;
    showQuestion();
  } else if (answers.hasCommitments === 'نعم') {
    const q = commitmentQuestions[commitmentStep];
    if (q.id === 'anotherCommitment') {
      if (currentCommitment[q.id] === 'نعم') {
        answers.commitments.push(currentCommitment);
        currentCommitment = {};
        commitmentStep = 0;
        showQuestion();
      } else {
        answers.commitments.push(currentCommitment);
        calculate();
        document.getElementById('nextContainer').style.display = 'none';
      }
    } else {
      commitmentStep++;
      showQuestion();
    }
  }
}
</script>