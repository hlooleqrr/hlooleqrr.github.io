<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>سرعة تملك العقار والحلول التمويلية</title>
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f4f6f8; margin: 0; text-align: center; font-size: 32px; }
    header { background: #005c48; color: #fff; padding: 25px; font-size: 40px; }
    h2 { font-size: 32px; margin: 10px 0 20px; }
    .container { max-width:650px; margin:0 auto 25px; background:#fff; padding:25px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,.1); }
    input, select, button { width:92%; padding:20px; margin:18px 0; font-size:32px; border-radius:5px; border:1px solid #ccc; box-sizing:border-box; }
    .result p { margin:12px 0; }
    .highlight { color:#2e7d32; font-size:36px; }
  </style>
</head>
<body>
  <header>سرعة تملك العقار والحلول التمويلية</header>
  <h2>حاسبة التمويل التقريبية</h2>
  <div class="container" id="question">
    <button id="mainButton" onclick="handleStartOrReset()">ابدأ الحسبة</button>
    <div id="resetButtonContainer" style="display:none;">
      <button onclick="handleStartOrReset()">إعادة الحسبة 🔁</button>
    </div>
    <div id="nextContainer" style="display:none;">
      <button onclick="nextQuestion()">التالي</button>
    </div>
  </div>

<script>
let hasStarted=false, step=0, commitmentStep=0;
let answers={commitments:[]}, currentCommitment={};

// الأسئلة
const generalQuestions = [
  { id:'financeType', label:'اختر نوع التمويل تريد حسبته:', type:'select', options:['تمويل عقاري','تمويل شخصي أو استهلاكي'] },
  { id:'clientName',  label:'الاسم الكريم:', type:'text' },
  { id:'birthHijriDay',   label:'اليوم (هجري):',  type:'select', options:Array.from({length:30},(_,i)=>(i+1).toString()) },
  { id:'birthHijriMonth', label:'الشهر (هجري):',  type:'select', options:Array.from({length:12},(_,i)=>(i+1).toString()) },
  { id:'birthHijriYear',  label:'السنة (هجري):',  type:'select', options:Array.from({length:61},(_,i)=>(1370+i).toString()) },
  { id:'jobType',     label:'نوع الوظيفة:', type:'select', options:['عسكري','مدني','خاص شبه حكومي','خاص معتمد','خاص غير معتمد'] },
  { show:a=>a.jobType==='عسكري', id:'rank', label:'حدد رتبتك العسكرية:', type:'select',
    options:['جندي','جندي أول','عريف','وكيل رقيب','رقيب','رقيب أول','رئيس رقباء','ملازم','ملازم أول','نقيب','رائد','مقدم','عقيد','عميد','لواء'] },
  { show:()=>answers.jobType==='عسكري' && getRetirementMonths()<25*12,
    id:'extended', label:'هل تريد الحسبة ممتدة بعد التقاعد؟', type:'select', options:['نعم','لا'] },
  // أسئلة الممتد
  { show:a=>a.extended==='نعم', id:'baseSalary',      label:'الراتب الأساسي المتوقع عند التقاعد (ريال):', type:'number' },
  { show:a=>a.extended==='نعم', id:'appointDay',      label:'يوم التعيين (هجري):',  type:'select', options:Array.from({length:30},(_,i)=>(i+1).toString()) },
  { show:a=>a.extended==='نعم', id:'appointMonth',    label:'شهر التعيين (هجري):', type:'select', options:Array.from({length:12},(_,i)=>(i+1).toString()) },
  { show:a=>a.extended==='نعم', id:'appointYear',     label:'سنة التعيين (هجري):', type:'select', options:Array.from({length:61},(_,i)=>(1370+i).toString()) },
  // أشهر التمويل بعد السؤال عن الممتد
  { id:'months',      label:'عدد أشهر التمويل:', type:'select', dynamic:true },
  { id:'hasCommitments', label:'هل لديك التزامات مالية؟', type:'select', options:['نعم','لا'] },
];

// أسئلة الالتزامات
const commitmentQuestions = [
  { id:'type',    label:'نوع الالتزام:', type:'select', options:['قرض سيارة','قرض شخصي','قرض استهلاكي'] },
  { id:'amount',  label:'القيمة الشهرية للقسط (ريال):', type:'number' },
  { id:'months',  label:'عدد أشهر الالتزام المتبقية:', type:'select', dynamic:true },
  { id:'balloon', label:'هل لديك دفعة أخيرة؟', type:'select', options:['نعم','لا'] },
  { show:c=>c.balloon==='نعم', id:'balloonAmount', label:'مبلغ الدفعة الأخيرة (ريال):', type:'number' },
  { id:'more',    label:'هل لديك التزام آخر؟', type:'select', options:['نعم','لا'] },
];

// مساعدات
function getRetirementMonths(){
  const cur=1446, birth=parseInt(answers.birthHijriYear)||cur, age=cur-birth;
  const ranks={"جندي":44,"جندي أول":44,"عريف":46,"وكيل رقيب":46,"رقيب":48,"رقيب أول":50,"رئيس رقباء":52,"ملازم":48,"ملازم أول":50,"نقيب":52,"رائد":54,"مقدم":56,"عقيد":58,"عميد":60,"لواء":60};
  const retire = answers.jobType==='عسكري'? (ranks[answers.rank]||60) : 60;
  return Math.max(0,(retire-age)*12);
}
function getMaxAllowedMonths(){
  // قبل التقاعد
  let base = answers.extended==='نعم'
    ? (answers.financeType.includes('شخصي')?60:360)
    : (answers.financeType.includes('شخصي')
       ? Math.min(getRetirementMonths(),60)
       : Math.min(getRetirementMonths(),360));
  return base;
}
function describeMonths(m){
  const y=Math.floor(m/12), mm=m%12;
  let t=`${m} شهر`; if(y||mm){ t+=' ('; if(y) t+=`${y} سنة${y>1?'ات':''}`; if(y&&mm) t+=' و'; if(mm) t+=`${mm} شهر`; t+=')'; }
  return t;
}
function numberToArabicWords(n){
  const o=['','واحد','اثنان','ثلاثة','أربعة','خمسة','ستة','سبعة','ثمانية','تسعة'],
        t=['','', 'عشرون','ثلاثون','أربعون','خمسون','ستون','سبعون','ثمانون','تسعون'],
        h=['','مائة','مائتان','ثلاثمائة','أربعمائة','خمسمائة','ستمائة','سبعمائة','ثمانمائة','تسعمائة'],
        teen=['عشرة','إحدى عشر','اثنا عشر','ثلاثة عشر','أربعة عشر','خمسة عشر','ستة عشر','سبعة عشر','ثمانية عشر','تسعة عشر'];
  let p=[];
  if(n>=100){ let q=Math.floor(n/100); p.push(h[q]); n%=100; }
  if(n>=20){ let q=Math.floor(n/10); p.push(t[q]); n%=10; }
  else if(n>=10){ p.push(teen[n-10]); n=0; }
  if(n>0) p.push(o[n]);
  return p.join(' و ');
}

// التحكم
function handleStartOrReset(){
  if(!hasStarted){
    hasStarted=true;
    document.getElementById('mainButton').style.display='none';
    document.getElementById('resetButtonContainer').style.display='block';
    showQuestion();
  } else resetCalc();
}
function resetCalc(){
  answers={commitments:[]}; step=commitmentStep=0; currentCommitment={};
  hasStarted=true;
  document.getElementById('mainButton').style.display='none';
  document.getElementById('resetButtonContainer').style.display='block';
  showQuestion();
}
function showQuestion(){
  const cont=document.getElementById('question');
  cont.innerHTML=''; document.getElementById('nextContainer').style.display='block';
  let q;
  if(step<generalQuestions.length){
    q=generalQuestions[step];
    if(q.show&&!q.show(answers)){ step++; return showQuestion(); }
  } else if(answers.hasCommitments==='نعم'){
    q=commitmentQuestions[commitmentStep];
    if(q.show&&!q.show(currentCommitment)){ commitmentStep++; return showQuestion(); }
  } else { document.getElementById('nextContainer').style.display='none'; return calculate(); }

  const div=document.createElement('div'); div.classList.add('fade-in');
  div.innerHTML=`<label>${q.label}</label><br>`;
  if(q.type==='select'){
    const sel=document.createElement('select'); sel.id=q.id;
    sel.innerHTML='<option value="">اختر...</option>';
    if(q.dynamic){
      for(let i=1;i<=getMaxAllowedMonths();i++) sel.innerHTML+=`<option value="${i}">${i} شهر</option>`;
    } else {
      q.options.forEach(o=> sel.innerHTML+=`<option value="${o}">${o}</option>`);
    }
    div.appendChild(sel);
  } else {
    div.innerHTML+=`<input type="${q.type}" id="${q.id}" ${q.default?`value="${q.default}"`:''}>`;
  }
  cont.appendChild(div);
}
function nextQuestion(){
  const q= step<generalQuestions.length? generalQuestions[step] : commitmentQuestions[commitmentStep];
  const el=document.getElementById(q.id), val=el.value;
  if(!val){ alert('يرجى تعبئة الحقل'); return; }
  if(step<generalQuestions.length){
    answers[q.id]=val;
    if(q.id==='months'&&parseInt(val)>getMaxAllowedMonths()){
      alert(`أقصى مدة: ${describeMonths(getMaxAllowedMonths())}`); answers[q.id]=getMaxAllowedMonths().toString();
    }
    step++;
  } else {
    if(q.id==='months') currentCommitment.months=parseInt(val);
    else if(['amount','balloonAmount'].includes(q.id)) currentCommitment[q.id]=parseFloat(val);
    else currentCommitment[q.id]=val;
    if(q.id==='more'){
      answers.commitments.push(currentCommitment);
      currentCommitment={};
      if(val==='نعم'){ commitmentStep=0; return showQuestion(); }
      else{ document.getElementById('nextContainer').style.display='none'; return calculate(); }
    }
    commitmentStep++;
  }
  showQuestion();
}

// الحساب
function calculate(){
  const salary=parseFloat(answers.salary), months=parseInt(answers.months),
        years=months/12, profitMargin=parseFloat(answers.profitMargin),
        {financeType,supported,bundle,extended,baseSalary}=answers;
  let rate=0, addComm=false;
  if(financeType.includes('شخصي')||financeType.includes('استهلاكي')){ rate=45; addComm=true; }
  else rate = supported==='مدعوم' ? (bundle==='لا'?65:(salary<15000?55:65)) : (salary<15000?55:65);

  const currentAllowed = salary*rate/100;
  const retireAllowed = parseFloat(baseSalary||salary)*rate/100;

  const commits=[...answers.commitments].sort((a,b)=>a.months-b.months);
  const balloons=commits.filter(c=>c.type==='قرض سيارة'&&c.balloon==='نعم'&&c.balloonAmount)
    .map(c=>({start:c.months,end:c.months+24,value:c.balloonAmount/24}));

  const retirementMonthCount = getRetirementMonths();

  const phases=[];
  for(let m=1;m<=months;m++){
    const active=commits.filter(c=>m<=c.months).reduce((s,c)=>s+(c.amount||0),0);
    const extra=balloons.reduce((s,b)=>(m>=b.start&&m<b.end)?s+b.value:s,0);
    let avail = (extended==='نعم' && m>retirementMonthCount) ? retireAllowed : currentAllowed;
    avail = avail - active - extra;
    if(financeType.includes('شخصي')||financeType.includes('استهلاكي'))
      avail = Math.min(avail, salary*0.3333);
    if(m===1||avail!==phases[phases.length-1].inst)
      phases.push({from:m,to:m,inst:avail});
    else
      phases[phases.length-1].to = m;
  }

  const total=phases.reduce((s,p)=>s+p.inst*(p.to-p.from+1),0);
  const factor=years*profitMargin/100+1;
  const net=total/factor;
  let admin=net*0.01, vat=admin*0.15;
  if(admin+vat>5750){admin=5000;vat=750;}
  const commFee=addComm?net*0.01:0, finalNet=net-(admin+vat+commFee),
        profitFees=total-finalNet;

  let supportText='';
  if(financeType==='تمويل عقاري'&&supported==='مدعوم'&&bundle==='نعم'){
    const sup=salary<10000?150000:100000;
    supportText=`<p class="highlight">دعم حكومي مضاف: ${sup.toLocaleString()} ريال</p>`;
  }

  const name=answers.clientName||'العميل', duration=describeMonths(months), fixed=finalNet.toFixed(0);

  let html='<div class="result"><h2>نتيجة الحسبة (التقريبية):</h2>';
  html+=`<p style="color:#1565c0;font-size:36px;"><strong>مرحباً يا ${name}</strong></p>`;
  html+=`<p>مدة التمويل: <strong>${duration}</strong></p>`;
  if(phases.some(p=>p.inst<=0))
    html+=`<p style="color:red;font-size:38px;font-weight:bold;">نعتذر لا يمكن تمويلك</p>`;
  phases.forEach(p=>{
    html+=`<p><strong>القسط من ${p.from} إلى ${p.to}:</strong> ${p.inst.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")} ريال</p>`;
  });
  html+=`
    <p style="color:green;font-size:44px;font-weight:bold;">الصافي بعد الرسوم: ${fixed.replace(/\B(?=(\d{3})+(?!\d))/g,",")} ريال</p>
    ${supportText}
    <p style="color:green;font-size:36px;"><strong>الصافي قبل الرسوم:</strong> ${net.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")} ريال</p>
    <p style="color:red;font-size:36px;"><strong>الربح دون رسوم:</strong> ${(total-net).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")} ريال</p>
    <p style="color:red;font-size:42px;"><strong>الربح مع رسوم:</strong> ${profitFees.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,",")} ريال</p>
    <p><strong>المعامل:</strong> ${factor.toFixed(3)}</p>
    <p><strong>إدارية:</strong> ${admin.toFixed(0)} ريال</p>
    <p><strong>ضريبة:</strong> ${vat.toFixed(0)} ريال</p>
    ${commFee?`<p><strong>سلع:</strong> ${commFee.toFixed(0)} ريال</p>`:''}
    <p><strong>بالأحرف:</strong> ${numberToArabicWords(parseInt(fixed))}</p>
    <h3 style="margin-top:30px;">📞0506214458 | hlooleqrr.com</h3>
  </div>`;
  document.getElementById('question').innerHTML=html;
}
</script>

<footer>
  <p>جميع الحقوق محفوظة - سرعة تملك العقار والحلول التمويلية - 
    <span id="datetime"></span>
  </p>
</footer>
<script>
function updateDateTime(){
  const d=new Date();
  document.getElementById('datetime').innerText=
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`+
    ` ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
}
setInterval(updateDateTime,1000);
updateDateTime();
</script>
</body>
</html>