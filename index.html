<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>حاسبة التمويل بعد التقاعد – محدثة</title>
  <script src="https://cdn.jsdelivr.net/npm/hijri-date/lib/hijri-date.min.js"></script>
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #f4f6f8; margin:0; padding:20px; text-align:center; font-size:24px; }
    .step { display:none; max-width:700px; margin:auto; background:#fff; padding:30px; border-radius:12px; box-shadow:0 0 15px rgba(0,0,0,0.1); }
    .step.active { display:block; }
    input, select, button { width:90%; padding:15px; margin:15px 0; font-size:22px; border-radius:6px; }
    .result { background:#e6f7ff; padding:20px; margin-top:20px; border:2px solid #0099cc; border-radius:12px; font-size:26px; line-height:1.6; text-align:right; }
    table { width:100%; border-collapse:collapse; margin:20px 0; }
    th, td { border:1px solid #ccc; padding:8px; }
    th { background:#e6f7ff; }
  </style>
</head>
<body>

  <!-- خطوة 0: عرض التاريخ -->
  <div class="step active" id="step0">
    <h2>حاسبة التمويل بعد التقاعد</h2>
    <p>اليوم (هجري): <span id="todayHijri"></span> | (ميلادي: <span id="todayGregorian"></span>)</p>
    <button onclick="nextStep()">ابدأ الحسبة</button>
  </div>

  <!-- خطوة 1: الاسم -->
  <div class="step" id="step1">
    <h3>ما اسمك الكريم؟</h3>
    <input type="text" id="clientName" placeholder="الاسم الكريم">
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 2: نوع التمويل -->
  <div class="step" id="step2">
    <h3>نوع التمويل</h3>
    <select id="financeType">
      <option disabled selected>اختر نوع التمويل</option>
      <option value="person">تمويل شخصي</option>
      <option value="realestate">تمويل عقاري</option>
    </select>
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 3: جهة العمل -->
  <div class="step" id="step3">
    <h3>جهة العمل</h3>
    <select id="jobType" onchange="toggleRank()">
      <option disabled selected>اختر جهة العمل</option>
      <option value="civil">حكومي مدني</option>
      <option value="private">قطاع خاص</option>
      <option value="military">عسكري</option>
    </select>
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 4: الرتبة -->
  <div class="step" id="step4">
    <h3>اختر الرتبة (للعسكري فقط)</h3>
    <select id="rank">
      <option disabled selected>اختر الرتبة</option>
      <option value="جندي">جندي</option>
      <option value="جندي أول">جندي أول</option>
      <option value="عريف">عريف</option>
      <option value="وكيل رقيب">وكيل رقيب</option>
      <option value="رقيب">رقيب</option>
      <option value="رقيب أول">رقيب أول</option>
      <option value="رئيس رقباء">رئيس رقباء</option>
      <option value="ملازم">ملازم</option>
      <option value="ملازم أول">ملازم أول</option>
      <option value="نقيب">نقيب</option>
      <option value="رائد">رائد</option>
      <option value="مقدم">مقدم</option>
      <option value="عقيد">عقيد</option>
      <option value="عميد">عميد</option>
      <option value="لواء">لواء</option>
    </select>
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 5: تاريخ الميلاد -->
  <div class="step" id="step5">
    <h3>تاريخ الميلاد (هجري)</h3>
    <select id="birthDay"></select>
    <select id="birthMonth"></select>
    <select id="birthYear"></select>
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 6: تاريخ التعيين -->
  <div class="step" id="step6">
    <h3>تاريخ التعيين (هجري)</h3>
    <select id="hireDay"></select>
    <select id="hireMonth"></select>
    <select id="hireYear"></select>
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 7: التمويل الصافي قبل التقاعد -->
  <div class="step" id="step7">
    <h3>التمويل الصافي قبل التقاعد (ريال)</h3>
    <input type="number" id="netBefore" placeholder="مثال: 500000">
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 8: نسبة الربح يحددها العميل -->
  <div class="step" id="step8">
    <h3>نسبة الربح السنوية (%)</h3>
    <input type="number" id="profitRate" placeholder="مثال: 5">
    <button onclick="nextStep()">التالي</button>
  </div>

  <!-- خطوة 9: عدد أشهر التمويل بعد التقاعد -->
  <div class="step" id="step9">
    <h3>عدد أشهر التمويل بعد التقاعد</h3>
    <p>اختر من 1 إلى <span id="maxMonths"></span> شهراً</p>
    <select id="periodSelect"></select>
    <button onclick="calculate()">عرض النتيجة</button>
  </div>

  <!-- خطوة 10: النتيجة والجدول -->
  <div class="step" id="step10">
    <div class="result" id="resultBox"></div>
    <h4>جدول الرواتب والعلاوات وسن التقاعد</h4>
    <table>
      <thead>
        <tr><th>الرتبة</th><th>الراتب الأساسي</th><th>العلاوة السنوية</th><th>سن التقاعد</th></tr>
      </thead>
      <tbody id="rankTable"></tbody>
    </table>
  </div><script>
document.addEventListener('DOMContentLoaded', () => {
  // تعبئة القوائم بالأيام والشهور والسنوات
  for (let i = 1; i <= 30; i++) {
    birthDay.innerHTML += `<option value="${i}">${i}</option>`;
    hireDay.innerHTML += `<option value="${i}">${i}</option>`;
  }
  for (let m = 1; m <= 12; m++) {
    birthMonth.innerHTML += `<option value="${m}">${m}</option>`;
    hireMonth.innerHTML += `<option value="${m}">${m}</option>`;
  }
  for (let y = 1370; y <= 1447; y++) {
    birthYear.innerHTML += `<option value="${y}">${y}</option>`;
    hireYear.innerHTML += `<option value="${y}">${y}</option>`;
  }

  // جدول الرتب
  const ranks = [
    ["جندي",3220,130,44],["جندي أول",3395,145,44],["عريف",3765,175,46],
    ["وكيل رقيب",4455,250,46],["رقيب",5260,300,48],["رقيب أول",6180,360,50],
    ["رئيس رقباء",7215,360,52],["ملازم",7590,380,48],["ملازم أول",8365,440,50],
    ["نقيب",9215,495,52],["رائد",11735,265,54],["مقدم",12735,470,56],
    ["عقيد",14365,590,58],["عميد",16350,650,60],["لواء",18600,730,60]
  ];
  ranks.forEach(r => {
    rankTable.innerHTML += `<tr>
      <td>${r[0]}</td><td>${r[1].toLocaleString()}</td>
      <td>${r[2].toLocaleString()}</td><td>${r[3]}</td>
    </tr>`;
  });

  // عرض التاريخ الحالي
  const todayHijri = new HijriDate();
  todayHijriSpan = document.getElementById('todayHijri');
  todayGregSpan  = document.getElementById('todayGregorian');
  todayHijriSpan.innerText = `${todayHijri.getDate()}/${todayHijri.getMonth()+1}/${todayHijri.getFullYear()}`;
  const todayGreg = todayHijri.toGregorian();
  todayGregSpan.innerText = `${todayGreg.getDate()}/${todayGreg.getMonth()+1}/${todayGreg.getFullYear()}`;
});

const retirementAges = { /* ... كما في السابق ... */ };
const baseSalaries   = { /* ... كما في السابق ... */ };
const raises         = { /* ... كما في السابق ... */ };

let currentStep = 0;
function nextStep() {
  document.getElementById('step' + currentStep).classList.remove('active');
  currentStep++;
  // تخطّي خطوة الرتبة إذا لم يكن عسكرياً
  if (currentStep === 4 && jobType.value !== 'military') {
    currentStep++;
  }
  // قبل عرض خطوة اختيار المدة، احسب الحد الأقصى
  if (currentStep === 9) {
    const rankVal = rank.value || 'مدني/خاص';
    const birthHijri = new HijriDate(parseInt(birthYear.value), parseInt(birthMonth.value)-1, parseInt(birthDay.value));
    const retirementAge = retirementAges[rankVal] || 60;
    const maxMonths = (60 - retirementAge) * 12;
    document.getElementById('maxMonths').innerText = maxMonths;
    periodSelect.innerHTML = '';
    for (let i = 1; i <= maxMonths; i++) {
      periodSelect.innerHTML += `<option value="${i}">${i}</option>`;
    }
  }
  document.getElementById('step' + currentStep).classList.add('active');
}

function toggleRank() {
  // يُدار ضمن nextStep
}

function calculate() {
  // جمع بيانات العميل
  const name      = clientName.value.trim();
  const type      = financeType.value;
  const job       = jobType.value;
  const rankVal   = rank.value || 'مدني/خاص';
  const by        = parseInt(birthYear.value),
        bm        = parseInt(birthMonth.value)-1,
        bd        = parseInt(birthDay.value);
  const hy        = parseInt(hireYear.value),
        hm        = parseInt(hireMonth.value)-1,
        hd        = parseInt(hireDay.value);
  const netBefore = parseFloat(netBefore.value);
  const profitPct = parseFloat(profitRate.value) / 100;
  const period    = parseInt(periodSelect.value);

  // التحقق
  if (!name || !type || !job || (job==='military' && !rank.value) ||
      isNaN(by)||isNaN(bm)||isNaN(bd)||isNaN(hy)||isNaN(hm)||isNaN(hd)||
      isNaN(netBefore)||isNaN(profitPct)||isNaN(period)) {
    alert('يرجى إكمال جميع الحقول');
    return;
  }

  // حسابات التقاعد
  const birthHijri   = new HijriDate(by, bm, bd),
        hireHijri    = new HijriDate(hy, hm, hd),
        todayHijri   = new HijriDate();
  let ageNow = todayHijri.getFullYear() - birthHijri.getFullYear();
  if (todayHijri.getMonth() < birthHijri.getMonth() ||
      (todayHijri.getMonth() === birthHijri.getMonth() && todayHijri.getDate() < birthHijri.getDate())) {
    ageNow--;
  }

  const retirementAge = retirementAges[rankVal] || 60,
        retireHijri   = new HijriDate(birthHijri.getFullYear() + retirementAge, bm, bd),
        retireGreg    = retireHijri.toGregorian();
  const yearsService = retireHijri.getFullYear() - hireHijri.getFullYear();
  const base         = baseSalaries[rankVal] || 0;
  const lastSalary   = base + (raises[rankVal] || 0) * yearsService;
  const retirementSalary = (lastSalary * yearsService) / 40;

  // حسبة التمويل
  const installment      = retirementSalary * ((type==='person')?0.25:(retirementSalary<15000?0.55:0.65));
  const totalWithProfit  = installment * period;
  const profit           = totalWithProfit * profitPct;
  const netAfter         = totalWithProfit - profit;
  const totalFinance     = netBefore + netAfter;
  const f = n => parseFloat(n).toLocaleString('ar-EG');

  // عرض النتيجة
  document.getElementById('step9').classList.remove('active');
  document.getElementById('step10').classList.add('active');
  resultBox.innerHTML = `
    <strong>مرحباً ومسهلاً يا ${name}</strong><br>
    <strong>العمر الحالي:</strong> ${ageNow} سنة<br>
    <strong>تاريخ التقاعد (هجري):</strong> ${retireHijri.getDate()}/${retireHijri.getMonth()+1}/${retireHijri.getFullYear()}<br>
    <strong>تاريخ التقاعد (ميلادي):</strong> ${retireGreg.getDate()}/${retireGreg.getMonth()+1}/${retireGreg.getFullYear()}<br>
    <strong>سنوات الخدمة:</strong> ${yearsService} سنة<br>
    <strong>الراتب الأساسي:</strong> ${f(base)} ريال<br>
    <strong>آخر راتب قبل التقاعد:</strong> ${f(lastSalary)} ريال<br>
    <strong>الراتب التقاعدي:</strong> ${f(retirementSalary.toFixed(2))} ريال<br>
    <strong>التمويل الصافي قبل التقاعد:</strong> ${f(netBefore)} ريال<br>
    <strong>عدد أشهر التمويل:</strong> ${period} شهر<br>
    <strong>نسبة الربح:</strong> ${(profitPct*100).toFixed(2)}%<br>
    <strong>الربح المحسوب:</strong> ${f(profit.toFixed(2))} ريال<br>
    <strong>التمويل الصافي بعد التقاعد:</strong> ${f(netAfter.toFixed(0))} ريال<br>
    ✅ <strong>التمويل الصافي قبل + بعد التقاعد:</strong> ${f(totalFinance.toFixed(0))} ريال
  `;
}
</script>
</body>
</html>