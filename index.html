<script>
  // ملء قوائم السنوات من 1370 حتى 1460 (هجري)
  function populateSelect(selectElem, start, end) {
    selectElem.innerHTML = '';
    for(let i = start; i <= end; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i;
      selectElem.appendChild(option);
    }
  }
  function populateDays(selectElem) {
    selectElem.innerHTML = '';
    for(let i = 1; i <= 30; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i < 10 ? '0' + i : i;
      selectElem.appendChild(option);
    }
  }
  function populateMonths(selectElem) {
    selectElem.innerHTML = '';
    for(let i = 1; i <= 12; i++) {
      const option = document.createElement('option');
      option.value = i;
      option.textContent = i < 10 ? '0' + i : i;
      selectElem.appendChild(option);
    }
  }

  // عرض التاريخ الهجري والميلادي في الفوتر
  function updateDateTimeFooter() {
    const dateTimeSpan = document.getElementById('dateTime');
    const now = new Date();
    // التاريخ الميلادي
    const gregDate = now.toLocaleDateString('ar-SA-u-nu-latn', { year: 'numeric', month: 'long', day: 'numeric' });
    // التاريخ الهجري باستخدام Intl.DateTimeFormat (إن دعم المتصفح)
    let hijriDate = '';
    try {
      hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { year: 'numeric', month: 'long', day: 'numeric' }).format(now);
    } catch {
      hijriDate = 'غير مدعوم في المتصفح';
    }
    dateTimeSpan.textContent = `التاريخ الميلادي: ${gregDate} | التاريخ الهجري: ${hijriDate}`;
  }

  // بيانات التقاعد حسب الرتبة
  const retirementAges = {
    "ملازم": 44, "ملازم أول": 44,
    "نقيب": 46,
    "رائد": 48,
    "مقدم": 50,
    "عقيد": 52,
    "عميد": 54,
    "لواء": 56,
    "فريق": 58,
    "فريق أول": 58,
    "جندي": 44,
    "جندي أول": 44,
    "عريف": 46,
    "وكيل رقيب": 48,
    "رقيب": 50,
    "رقيب أول": 50,
    "رئيس رقباء": 52
  };

  // الرواتب الأساسية حسب الرتبة (مثال مبسط)
  const salariesIndividuals = {
    "جندي":      [3220, 3350, 3480, 3610, 3740, 3870, 4000, 4130, 4260, 4390, 4520, 4650, 4780, 4910, 5040],
    "جندي أول":  [3395, 3530, 3665, 3800, 3935, 4070, 4205, 4340, 4475, 4610, 4745, 4880, 5015, 5150, 5285],
    "عريف":      [3715, 3855, 3995, 4135, 4275, 4415, 4555, 4695, 4835, 4975, 5115, 5255, 5395, 5535, 5675],
    "وكيل رقيب": [4000, 4150, 4300, 4450, 4600, 4750, 4900, 5050, 5200, 5350, 5500, 5650, 5800, 5950, 6100],
    "رقيب":      [4370, 4530, 4690, 4850, 5010, 5170, 5330, 5490, 5650, 5810, 5970, 6130, 6290, 6450, 6610],
    "رقيب أول":  [4700, 4865, 5030, 5195, 5360, 5525, 5690, 5855, 6020, 6185, 6350, 6515, 6680, 6845, 7010],
    "رئيس رقباء":[4950, 5120, 5290, 5460, 5630, 5800, 5970, 6140, 6310, 6480, 6650, 6820, 6990, 7160, 7330]
  };

  const salariesOfficers = {
    "ملازم":    [8835, 9110, 9385, 9660, 9935, 10210, 10485, 10760, 11035, 11310, 11585, 11860, 12135, 12410, 12685],
    "ملازم أول":[9715, 10055, 10495, 10935, 11375, 11815, 12255, 12695, 13135, 13575, 14015, 14455, 14895, 15335, 15775],
    "نقيب":     [11940, 12390, 12840, 13290, 13740, 14190, 14640, 15090, 15540, 15990, 16440, 16890, 17340, 17790, 18240],
    "رائد":     [14155, 14620, 15085, 15550, 16015, 16480, 16945, 17410, 17875, 18340, 18805, 19270, 19735, 20200, 20665],
    "مقدم":     [16400, 16880, 17360, 17840, 18320, 18800, 19280, 19760, 20240, 20720, 21200, 21680, 22160, 22640, 23120],
    "عقيد":     [18800, 19300, 19800, 20300, 20800, 21300, 21800, 22300, 22800, 23300, 23800, 24300, 24800, 25300, 25800],
    "عميد":     [22000, 22520, 23040, 23560, 24080, 24600, 25120, 25640, 26160, 26680, 27200, 27720, 28240, 28760, 29280],
    "لواء":     [23500, 24100, 24700, 25300, 25900, 26500, 27100, 27700, 28300, 28900, 29500, 30100, 30700, 31300, 31900],
    "فريق":     [29500, 30100, 30700, 31300, 31900, 32500, 33100, 33700, 34300, 34900, 35500, 36100, 36700, 37300, 37900],
    "فريق أول": [31900, 32500, 33100, 33700, 34300, 34900, 35500, 36100, 36700, 37300, 37900, 38500, 39100, 39700, 40300]
  };

  // تخزين البيانات المدخلة
  let answers = {
    clientName: '',
    retirementType: '',
    birthYear: null,
    birthMonth: null,
    birthDay: null,
    joinYear: null,
    joinMonth: null,
    joinDay: null,
    rank: ''
  };

  // تنقل الخطوات
  function showStep(stepNum) {
    const steps = document.querySelectorAll('.step');
    steps.forEach(s => s.classList.remove('active'));
    document.getElementById('step' + stepNum).classList.add('active');
  }

  // تفعيل زر التالي إذا تم ملء الحقول المطلوبة
  function toggleNextButton(stepNum) {
    let enable = false;
    if(stepNum === 2) {
      const val = document.getElementById('clientName').value.trim();
      enable = val.length > 0;
    } else if(stepNum === 3) {
      const val = document.getElementById('retirementType').value;
      enable = val !== '';
    } else if(stepNum === 4) {
      const y = document.getElementById('birthYear').value;
      const m = document.getElementById('birthMonth').value;
      const d = document.getElementById('birthDay').value;
      enable = y && m && d;
    } else if(stepNum === 5) {
      const y = document.getElementById('joinYear').value;
      const m = document.getElementById('joinMonth').value;
      const d = document.getElementById('joinDay').value;
      enable = y && m && d;
    } else if(stepNum === 6) {
      const val = document.getElementById('rank').value;
      enable = val !== '';
    }
    document.getElementById('step' + stepNum + 'Next').disabled = !enable;
  }

  // تهيئة القوائم عند تحميل الصفحة
  window.addEventListener('DOMContentLoaded', () => {
    // ملء قوائم تواريخ الميلاد والتعيين
    populateSelect(document.getElementById('birthYear'), 1370, 1460);
    populateMonths(document.getElementById('birthMonth'));
    populateDays(document.getElementById('birthDay'));

    populateSelect(document.getElementById('joinYear'), 1370, 1460);
    populateMonths(document.getElementById('joinMonth'));
    populateDays(document.getElementById('joinDay'));

    updateDateTimeFooter();

    // زر ابدأ الحسبة
    document.getElementById('startBtn').addEventListener('click', () => {
      showStep(2);
    });

    // الخطوة 2: الاسم الكريم
    const clientNameInput = document.getElementById('clientName');
    clientNameInput.addEventListener('input', () => {
      toggleNextButton(2);
    });
    document.getElementById('step2Next').addEventListener('click', () => {
      answers.clientName = clientNameInput.value.trim();
      document.getElementById('clientNameDisplay3').textContent = answers.clientName;
      document.getElementById('clientNameDisplay4').textContent = answers.clientName;
      document.getElementById('clientNameDisplay5').textContent = answers.clientName;
      document.getElementById('clientNameDisplay6').textContent = answers.clientName;
      showStep(3);
    });
    document.getElementById('step2Prev').addEventListener('click', () => {
      showStep(1);
    });

    // الخطوة 3: نوع التقاعد
    const retirementTypeSelect = document.getElementById('retirementType');
    retirementTypeSelect.addEventListener('change', () => {
      toggleNextButton(3);
      // إظهار أو إخفاء اختيار الرتبة العسكرية
      if(retirementTypeSelect.value === 'military'){
        document.getElementById('step6').style.display = 'flex';
      } else {
        document.getElementById('step6').style.display = 'none';
      }
    });
    document.getElementById('step3Next').addEventListener('click', () => {
      answers.retirementType = retirementTypeSelect.value;
      showStep(4);
    });
    document.getElementById('step3Prev').addEventListener('click', () => {
      showStep(2);
    });

    // الخطوة 4: تاريخ الميلاد
    ['birthYear', 'birthMonth', 'birthDay'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        toggleNextButton(4);
      });
    });
    document.getElementById('step4Next').addEventListener('click', () => {
      answers.birthYear = parseInt(document.getElementById('birthYear').value);
      answers.birthMonth = parseInt(document.getElementById('birthMonth').value);
      answers.birthDay = parseInt(document.getElementById('birthDay').value);
      showStep(5);
    });
    document.getElementById('step4Prev').addEventListener('click', () => {
      showStep(3);
    });

    // الخطوة 5: تاريخ التعيين
    ['joinYear', 'joinMonth', 'joinDay'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        toggleNextButton(5);
      });
    });
    document.getElementById('step5Next').addEventListener('click', () => {
      answers.joinYear = parseInt(document.getElementById('joinYear').value);
      answers.joinMonth = parseInt(document.getElementById('joinMonth').value);
      answers.joinDay = parseInt(document.getElementById('joinDay').value);

      if(answers.retirementType === 'military'){
        showStep(6);
      } else {
        // بدون رتبة للمدنيين
        answers.rank = '';
        showStep(7);
        calculateAndShowResult();
      }
    });
    document.getElementById('step5Prev').addEventListener('click', () => {
      showStep(4);
    });

    // الخطوة 6: اختيار الرتبة العسكرية
    const rankSelect = document.getElementById('rank');
    rankSelect.addEventListener('change', () => {
      toggleNextButton(6);
    });
    document.getElementById('step6Next').addEventListener('click', () => {
      answers.rank = rankSelect.value;
      showStep(7);
      calculateAndShowResult();
    });
    document.getElementById('step6Prev').addEventListener('click', () => {
      showStep(5);
    });

    // إعادة الحسبة زر
    document.getElementById('resetBtn').addEventListener('click', () => {
      answers = {
        clientName: '',
        retirementType: '',
        birthYear: null,
        birthMonth: null,
        birthDay: null,
        joinYear: null,
        joinMonth: null,
        joinDay: null,
        rank: ''
      };
      // إعادة تعيين الحقول
      document.getElementById('clientName').value = '';
      document.getElementById('retirementType').value = '';
      document.getElementById('birthYear').value = '';
      document.getElementById('birthMonth').value = '';
      document.getElementById('birthDay').value = '';
      document.getElementById('joinYear').value = '';
      document.getElementById('joinMonth').value = '';
      document.getElementById('joinDay').value = '';
      document.getElementById('rank').value = '';

      // إخفاء/إظهار الخطوات
      document.getElementById('step6').style.display = 'none';
      showStep(1);
      toggleNextButton(2);
      toggleNextButton(3);
      toggleNextButton(4);
      toggleNextButton(5);
      toggleNextButton(6);
      document.getElementById('result').innerHTML = '';
    });
  });

  // دالة حساب النتيجة وعرضها
  function calculateAndShowResult(){
    let resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '';

    // حساب عمر التقاعد (سنة التقاعد - سنة الميلاد)
    let retirementAge = 60; // الافتراضي مدني 60 سنة
    if(answers.retirementType === 'military' && answers.rank){
      retirementAge = retirementAges[answers.rank] || 60;
    }
    const birthYear = answers.birthYear || 1400; // قيمة احتياطية
    const ageAtRetirement = retirementAge; // سن التقاعد حسب الرتبة

    // حساب سنوات الخدمة
    const serviceYears = answers.joinYear && birthYear ? answers.joinYear - birthYear : 0;

    // حساب الراتب التقاعدي التقريبي بناءً على السنوات (البسيط)
    let salaryArray = [];
    if(answers.retirementType === 'military'){
      salaryArray = salariesIndividuals[answers.rank] || salariesOfficers[answers.rank] || [];
    } else {
      // راتب مدني تقديري (مثال ثابت)
      salaryArray = [10000]; 
    }
    // نأخذ راتب الخدمة الأخيرة (بفرض serviceYears كمؤشر)
    let salary = 0;
    if(salaryArray.length > 0){
      const index = Math.min(serviceYears, salaryArray.length -1);
      salary = salaryArray[index];
    } else {
      salary = 10000;
    }

    // النتيجة النهائية
    let html = `<p>مرحباً <span class="highlight">${answers.clientName}</span></p>`;
    html += `<p>نوع التقاعد: <span class="highlight">${answers.retirementType === 'military' ? 'عسكري